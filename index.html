<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS AI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Scrollbar customization to match the feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 selection:bg-cyan-500/30">

    <div id="app"></div>

    <script>
        /**
         * LIFE OS AI - LOGIC & STATE MANAGEMENT
         */

        // Constants
        const THEME = {
            bg: "bg-zinc-950",
            sidebar: "bg-zinc-900/50",
            card: "bg-zinc-900",
            accent: "text-cyan-400",
        };

        const apiKey = "AIzaSyDynh7tvCvruvnH80Ja04IE0KJP9_CIFqM"; 

        // Initial State
        const initialState = {
            view: 'onboarding',
            user: {
                name: '',
                age: '',
                focus: '',
                struggle: '',
                style: 'Honest',
                joinedDate: new Date().toISOString()
            },
            data: {
                logs: [],
                goals: [],
                lifeScore: 50,
                streak: 0,
                lastLogin: null
            },
            ui: {
                mobileMenuOpen: false,
                loading: false,
                aiResponse: null,
                modalOpen: false,
                modalContent: null,
                morningBriefing: null,
                loadingBriefing: false,
                analyzing: false,
                onboardingStep: 1,
                // Log Input State
                logInput: { focus: 5, wastedTime: 0, wins: '', failures: '' },
                // Goal Input
                goalInput: ''
            }
        };

        // Reactive State (Simple implementation)
        let state = { ...initialState };

        // --- API & LOGIC FUNCTIONS ---

        const generateAIResponse = async (prompt, systemContext) => {
            if (!apiKey) return "Simulation Mode: API Key missing.";
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemContext }] }
                        })
                    }
                );
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "System Error: Could not retrieve insight.";
            } catch (error) {
                console.error("AI Error:", error);
                return "Connection Error: The Reality Engine is offline.";
            }
        };

        const calculateLifeScore = () => {
            if (state.data.logs.length === 0) return 50;
            const last7Days = state.data.logs.slice(-7);
            const avgFocus = last7Days.reduce((acc, log) => acc + (parseInt(log.focus) || 0), 0) / last7Days.length;
            const consistency = Math.min(state.data.streak * 5, 30);
            const focusScore = (avgFocus / 10) * 40;
            const penalty = state.data.goals.filter(g => !g.active).length * 2;
            let score = 30 + consistency + focusScore - penalty;
            return Math.min(Math.max(Math.round(score), 0), 100);
        };

        // --- PERSISTENCE ---

        function loadData() {
            const savedUser = localStorage.getItem('lifeos_user');
            const savedData = localStorage.getItem('lifeos_data');
            if (savedUser && savedData) {
                state.user = JSON.parse(savedUser);
                state.data = JSON.parse(savedData);
                state.view = 'dashboard';
            }
            render();
        }

        function saveData() {
            if (state.user.name) {
                // Update Score before saving
                state.data.lifeScore = calculateLifeScore();
                localStorage.setItem('lifeos_user', JSON.stringify(state.user));
                localStorage.setItem('lifeos_data', JSON.stringify(state.data));
            }
        }

        // --- ACTION HANDLERS (Attached to Window for HTML access) ---

        window.actions = {
            setView: (view) => {
                state.view = view;
                state.ui.mobileMenuOpen = false; // Close menu on nav
                render();
            },
            toggleMobileMenu: () => {
                state.ui.mobileMenuOpen = !state.ui.mobileMenuOpen;
                render();
            },
            updateUser: (field, value) => {
                state.user[field] = value;
                saveData(); // Save usually happens on steps, but keeping sync is good
                render();
            },
            setOnboardingStep: (step) => {
                state.ui.onboardingStep = step;
                if (step > 4) {
                    state.view = 'dashboard';
                    saveData();
                }
                render();
            },
            closeModal: () => {
                state.ui.modalOpen = false;
                render();
            },
            // Dashboard Actions
            generateBriefing: async () => {
                state.ui.loadingBriefing = true;
                render();
                
                const mainGoal = state.data.goals.length > 0 ? state.data.goals[0].title : "General Self-Improvement";
                const context = `
                    Act as a high-performance coach. User: ${state.user.name}. 
                    Current Focus: ${state.user.focus}. Main Goal: ${mainGoal}. 
                    Recent Life Score: ${state.data.lifeScore}/100. Tone: ${state.user.style}.
                    Generate a concise "Morning Protocol" for today: 
                    1. THE MISSION (One priority). 2. THE ENEMY (Distraction). 3. THE MINDSET (Punchy thought).
                    Format with bold headers. Keep it short.
                `;
                const response = await generateAIResponse("Generate Morning Protocol", context);
                
                state.ui.morningBriefing = response;
                state.ui.loadingBriefing = false;
                render();
            },
            clearBriefing: () => {
                state.ui.morningBriefing = null;
                render();
            },
            // Goal Actions
            setGoalInput: (val) => {
                state.ui.goalInput = val;
                // No render needed strictly for input typing in vanilla unless strict binding, 
                // but we'll re-render to update value attribute
                render(); 
            },
            createGoal: async () => {
                const input = state.ui.goalInput;
                if (!input) return;
                
                state.ui.loading = true;
                state.ui.modalOpen = true;
                state.ui.modalContent = null;
                render();

                const systemPrompt = `
                    You are LifeOS. User wants: "${input}". 
                    Break into a SYSTEM. Format:
                    **Core Philosophy**: One sentence.
                    **Daily Protocol**: 3 actionable items.
                    **Non-Negotiables**: 1 rule.
                    **Reality Check**: Why they might fail.
                    Keep it short, matte, minimal.
                `;
                const aiResult = await generateAIResponse(input, systemPrompt);

                const newGoal = {
                    id: Date.now(),
                    title: input,
                    systemStr: aiResult,
                    active: true,
                    created: new Date().toISOString(),
                    system: { daily: ["Loading actions..."] }
                };

                state.data.goals.unshift(newGoal);
                state.ui.loading = false;
                state.ui.modalContent = aiResult;
                state.ui.goalInput = '';
                saveData();
                render();
            },
            deleteGoal: (id) => {
                state.data.goals = state.data.goals.filter(g => g.id !== id);
                saveData();
                render();
            },
            // Log Actions
            updateLog: (field, val) => {
                state.ui.logInput[field] = val;
                render();
            },
            submitLog: async () => {
                const log = state.ui.logInput;
                state.ui.loading = true;
                state.ui.modalOpen = true;
                state.ui.modalContent = null;
                render();

                const tone = state.user.style === 'Brutal' ? "You are a brutal, ruthless performance coach." : "You are a stoic mentor.";
                const context = `
                    ${tone} User: ${state.user.name}, Focus: ${state.user.focus}, Struggle: ${state.user.struggle}.
                    Log: Focus ${log.focus}/10, Wasted ${log.wastedTime}h, Wins: ${log.wins}, Failures: ${log.failures}.
                    Analyze. 1. Detect excuses. 2. Call out low focus. 3. Brief consistency check. Under 100 words.
                `;
                const feedback = await generateAIResponse("Analyze my day.", context);

                const newLog = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    focus: log.focus,
                    wastedTime: log.wastedTime,
                    wins: log.wins,
                    failures: log.failures,
                    feedback
                };

                state.data.logs.push(newLog);
                state.data.streak = parseInt(log.focus) > 5 ? state.data.streak + 1 : 0;
                
                state.ui.loading = false;
                state.ui.modalContent = feedback;
                // Reset input
                state.ui.logInput = { focus: 5, wastedTime: 0, wins: '', failures: '' };
                saveData();
                render();
            },
            // Analytics Actions
            runAnalysis: async () => {
                if (state.data.logs.length < 3) {
                   alert("Not enough data. Log at least 3 days.");
                   return;
                }
                state.ui.analyzing = true;
                render();

                const logHistory = state.data.logs.map(l => 
                    `Date: ${new Date(l.date).toDateString()}, Focus: ${l.focus}, Wins: ${l.wins}, Failures: ${l.failures}`
                ).join('\n');

                const context = `
                    Analyze user logs for hidden patterns. 
                    Point out ONE recurring issue and ONE strength.
                    Be highly analytical. Logs: ${logHistory}
                `;
                
                const response = await generateAIResponse("Analyze Patterns", context);
                state.ui.aiResponse = response; // reusing aiResponse for analytics insight
                state.ui.analyzing = false;
                render();
            },
            resetSystem: () => {
                if(confirm("Factory Reset: Are you sure?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
        };

        // --- RENDER FUNCTIONS (UI COMPONENTS) ---

        // Helper to handle Lucide icons in strings
        const icon = (name, size=18, classes='') => {
            return `<i data-lucide="${name}" width="${size}" height="${size}" class="${classes}"></i>`;
        };

        const OnboardingView = () => {
            const step = state.ui.onboardingStep;
            const u = state.user;

            let content = '';

            if (step === 1) {
                content = `
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-zinc-400">What should we call you?</label>
                        <input type="text" value="${u.name}" oninput="actions.updateUser('name', this.value)" 
                            class="w-full bg-transparent border-b border-zinc-700 py-3 text-xl focus:outline-none focus:border-cyan-500 transition-colors placeholder-zinc-800" placeholder="Name">
                        <label class="block text-sm font-medium text-zinc-400 mt-6">Age Range</label>
                        <div class="grid grid-cols-3 gap-3">
                            ${['Under 20', '20-30', '30+'].map(age => `
                                <button onclick="actions.updateUser('age', '${age}')"
                                    class="p-3 rounded border text-sm ${u.age === age ? 'border-cyan-500 bg-cyan-500/10 text-white' : 'border-zinc-800 text-zinc-500 hover:border-zinc-600'}">
                                    ${age}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (step === 2) {
                content = `
                    <div class="space-y-4">
                        <label class="block text-sm font-medium text-zinc-400">Primary Focus</label>
                        <div class="grid grid-cols-1 gap-3">
                            ${['Career & Business', 'Study & Academics', 'Fitness & Health', 'Discipline & Mindset'].map(f => `
                                <button onclick="actions.updateUser('focus', '${f}')"
                                    class="p-4 text-left rounded border transition-all ${u.focus === f ? 'border-cyan-500 bg-cyan-500/10 text-white' : 'border-zinc-800 text-zinc-500 hover:border-zinc-600 hover:bg-zinc-900'}">
                                    ${f}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (step === 3) {
                content = `
                     <div class="space-y-4">
                        <label class="block text-sm font-medium text-zinc-400">Biggest Struggle</label>
                        <div class="grid grid-cols-1 gap-3">
                            ${['Procrastination', 'Lack of Clarity', 'Inconsistency', 'Digital Distraction', 'Overwhelm'].map(s => `
                                <button onclick="actions.updateUser('struggle', '${s}')"
                                    class="p-4 text-left rounded border transition-all ${u.struggle === s ? 'border-purple-500 bg-purple-500/10 text-white' : 'border-zinc-800 text-zinc-500 hover:border-zinc-600 hover:bg-zinc-900'}">
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (step === 4) {
                content = `
                     <div class="space-y-6">
                        <label class="block text-sm font-medium text-zinc-400">Feedback Style</label>
                        <div class="grid grid-cols-3 gap-3">
                            ${['Soft', 'Honest', 'Brutal'].map(s => `
                                <button onclick="actions.updateUser('style', '${s}')"
                                    class="p-3 rounded border text-sm flex flex-col items-center gap-2 ${u.style === s ? 'border-cyan-500 bg-cyan-500/10 text-white' : 'border-zinc-800 text-zinc-500'}">
                                    ${s === 'Brutal' ? icon('shield-alert', 16) : s === 'Honest' ? icon('activity', 16) : icon('sun', 16)}
                                    ${s}
                                </button>
                            `).join('')}
                        </div>
                         <div class="bg-zinc-900 p-4 rounded border border-white/5 text-sm text-zinc-400">
                            ${u.style === 'Soft' ? "Gentle encouragement. Good for high-stress periods." : 
                              u.style === 'Honest' ? "Direct and objective. The standard LifeOS mode." : 
                              "No sugarcoating. Calls out excuses instantly. Not for the faint of heart."}
                        </div>
                    </div>
                `;
            }

            const canProceed = (step === 1 && u.name) || (step === 2 && u.focus) || (step === 3 && u.struggle) || step === 4;

            return `
                <div class="min-h-screen bg-zinc-950 flex flex-col items-center justify-center p-6 text-zinc-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-500 to-purple-600"></div>
                    <div class="absolute -top-40 -right-40 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl"></div>
                    <div class="absolute -bottom-40 -left-40 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl"></div>
                    
                    <div class="w-full max-w-md relative z-10">
                        <div class="mb-12 text-center">
                            <div class="flex justify-center mb-6 text-cyan-400">${icon('brain', 48)}</div>
                            <h1 class="text-3xl font-bold tracking-tight mb-2">Initialize LifeOS</h1>
                            <p class="text-zinc-500">System setup | Step ${step} of 4</p>
                        </div>
                        <div class="space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                            ${content}
                            <button onclick="actions.setOnboardingStep(${step + 1})" ${!canProceed ? 'disabled' : ''}
                                class="w-full bg-white text-black py-4 rounded font-bold hover:bg-zinc-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                ${step === 4 ? 'Launch System' : 'Continue'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const Sidebar = () => {
            const v = state.view;
            const score = state.data.lifeScore;
            
            const NavBtn = (id, lbl, icn) => `
                <button onclick="actions.setView('${id}')" 
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 group ${v === id ? 'bg-zinc-800 text-white' : 'text-zinc-500 hover:text-white hover:bg-zinc-800/50'}">
                    <span class="${v === id ? 'text-cyan-400' : 'group-hover:text-cyan-400'}">${icon(icn, 18)}</span>
                    <span class="font-medium text-sm tracking-wide">${lbl}</span>
                    ${v === id ? `<span class="ml-auto text-zinc-600">${icon('chevron-right', 14)}</span>` : ''}
                </button>
            `;

            return `
                <aside class="fixed md:relative z-40 h-full w-64 bg-zinc-900/50 border-r border-white/5 flex flex-col justify-between transition-transform duration-300 ${state.ui.mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}">
                     <div class="p-8 hidden md:flex items-center gap-3">
                        <div class="w-8 h-8 rounded bg-cyan-500/10 flex items-center justify-center text-cyan-400">${icon('brain', 20)}</div>
                        <h1 class="font-bold tracking-widest text-lg text-white">LIFEOS</h1>
                    </div>
                    <nav class="flex-1 px-4 py-4 space-y-2">
                        ${NavBtn('dashboard', 'Dashboard', 'layout-dashboard')}
                        ${NavBtn('goals', 'Systems & Goals', 'target')}
                        ${NavBtn('log', 'Daily Log', 'book-open')}
                        ${NavBtn('analytics', 'Analytics', 'activity')}
                    </nav>
                     <div class="p-4 border-t border-white/5">
                        ${NavBtn('settings', 'Settings', 'settings')}
                        <div class="mt-4 px-4 py-2 bg-zinc-900 rounded border border-white/5">
                            <p class="text-xs text-zinc-500 uppercase tracking-wider mb-1">Life Score</p>
                            <div class="flex items-end justify-between">
                                <span class="text-2xl font-bold text-white">${score}</span>
                                <span class="text-xs ${score > 70 ? 'text-emerald-400' : 'text-amber-400'}">${score > 70 ? 'OPTIMAL' : 'DRIFTING'}</span>
                            </div>
                            <div class="w-full bg-zinc-800 h-1 mt-2 rounded-full overflow-hidden">
                                <div class="bg-cyan-500 h-full transition-all duration-1000" style="width: ${score}%"></div>
                            </div>
                        </div>
                    </div>
                </aside>
            `;
        };

        const DashboardView = () => {
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Morning Protocol' : hour < 18 ? 'Afternoon Update' : 'Evening Review';
            const { lifeScore, goals, logs } = state.data;
            const { morningBriefing, loadingBriefing } = state.ui;

            let briefingHTML = '';
            if (!morningBriefing) {
                briefingHTML = `
                    <button onclick="actions.generateBriefing()" ${loadingBriefing ? 'disabled' : ''}
                        class="w-full bg-zinc-900 border border-zinc-800 hover:border-cyan-500/50 p-4 rounded-xl flex items-center justify-center gap-3 text-zinc-400 hover:text-cyan-400 transition-all group">
                        ${loadingBriefing ? `<div class="w-5 h-5 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>` 
                                          : `<span class="text-cyan-500 group-hover:animate-pulse">${icon('sparkles', 18)}</span>`}
                        <span class="font-mono text-sm tracking-widest uppercase">
                            ${loadingBriefing ? "GENERATING PROTOCOL..." : "INITIALIZE MORNING BRIEFING ✨"}
                        </span>
                    </button>
                `;
            } else {
                briefingHTML = `
                    <div class="bg-gradient-to-r from-zinc-900 to-zinc-900 border border-cyan-500/30 p-6 rounded-xl relative overflow-hidden animate-in zoom-in duration-300">
                        <div class="absolute top-0 right-0 p-4 opacity-10">${icon('sparkles', 64)}</div>
                        <div class="flex justify-between items-start mb-4">
                             <h3 class="text-cyan-400 font-mono text-xs uppercase tracking-widest flex items-center gap-2">
                                ${icon('zap', 14)} Morning Protocol
                             </h3>
                             <button onclick="actions.clearBriefing()" class="text-zinc-600 hover:text-white">${icon('x', 16)}</button>
                        </div>
                        <div class="whitespace-pre-line text-zinc-300 font-medium leading-relaxed">${morningBriefing}</div>
                    </div>
                `;
            }

            return `
                <div class="space-y-8 animate-in fade-in duration-500">
                    <header class="flex justify-between items-end border-b border-white/10 pb-6">
                        <div>
                            <h2 class="text-zinc-500 text-sm font-mono tracking-widest uppercase mb-1">${greeting}</h2>
                            <h1 class="text-3xl md:text-4xl font-bold text-white">Welcome back, ${state.user.name}.</h1>
                        </div>
                         <div class="text-right hidden md:block">
                            <p class="text-zinc-500 text-sm">Focus: <span class="text-cyan-400">${state.user.focus}</span></p>
                        </div>
                    </header>

                    ${briefingHTML}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-zinc-900 border border-white/5 p-6 rounded-xl relative overflow-hidden group hover:border-white/10 transition-all">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">${icon('activity', 64)}</div>
                            <p class="text-zinc-500 text-xs font-mono uppercase tracking-wider mb-2">Life Score</p>
                            <div class="flex items-end gap-3">
                                <span class="text-5xl font-bold text-white tracking-tighter">${lifeScore}</span>
                                <span class="text-sm text-zinc-400 mb-2">/ 100</span>
                            </div>
                            <div class="mt-4">
                                ${lifeScore < 50 
                                    ? `<p class="text-red-400 text-sm flex items-center gap-2">${icon('alert-triangle', 14)} System integrity critical.</p>`
                                    : `<p class="text-emerald-400 text-sm flex items-center gap-2">${icon('trending-up', 14)} System stable.</p>`}
                            </div>
                        </div>

                        <div class="md:col-span-2 bg-gradient-to-br from-zinc-900 to-zinc-950 border border-white/5 p-6 rounded-xl flex flex-col justify-center">
                            <p class="text-cyan-500 text-xs font-mono uppercase tracking-wider mb-3 flex items-center gap-2">${icon('target', 14)} Current Objective</p>
                            ${goals.length > 0 ? `
                                <div>
                                    <h3 class="text-xl font-medium text-white mb-1">${goals[0].title}</h3>
                                    <p class="text-zinc-500 text-sm line-clamp-1">Active System.</p>
                                </div>
                            ` : `
                                <div class="flex items-center justify-between">
                                    <p class="text-zinc-400">No active systems detected.</p>
                                    <button onclick="actions.setView('goals')" class="text-sm bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded">Initialize Goal</button>
                                </div>
                            `}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div onclick="actions.setView('log')" class="group cursor-pointer bg-zinc-900 border border-white/5 p-8 rounded-xl hover:bg-zinc-800/50 transition-all flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-cyan-400 transition-colors">Daily Log</h3>
                                <p class="text-zinc-500 mt-1">Input data. Track consistency.</p>
                            </div>
                            <span class="text-zinc-700 group-hover:text-cyan-400 transform group-hover:translate-x-1 transition-all">${icon('arrow-right', 20)}</span>
                        </div>
                        <div onclick="actions.setView('goals')" class="group cursor-pointer bg-zinc-900 border border-white/5 p-8 rounded-xl hover:bg-zinc-800/50 transition-all flex items-center justify-between">
                             <div>
                                <h3 class="text-xl font-bold text-white group-hover:text-purple-400 transition-colors">System Engine</h3>
                                <p class="text-zinc-500 mt-1">Refine goals. Optimize protocols.</p>
                            </div>
                            <span class="text-zinc-700 group-hover:text-purple-400 transform group-hover:translate-x-1 transition-all">${icon('arrow-right', 20)}</span>
                        </div>
                    </div>

                    <div class="border-t border-white/5 pt-8">
                        <h3 class="text-sm font-mono text-zinc-500 uppercase tracking-widest mb-4">Recent Activity</h3>
                        <div class="space-y-2">
                            ${logs.length > 0 ? logs.slice(-3).reverse().map(log => `
                                <div class="flex items-center justify-between p-4 bg-zinc-900/50 rounded border border-white/5">
                                    <span class="text-zinc-300">${new Date(log.date).toLocaleDateString()}</span>
                                    <span class="text-xs px-2 py-1 rounded ${parseInt(log.focus) > 7 ? 'bg-emerald-500/10 text-emerald-400' : 'bg-red-500/10 text-red-400'}">Focus: ${log.focus}/10</span>
                                </div>
                            `).join('') : '<p class="text-zinc-600 italic">No data points yet.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        const GoalsView = () => {
            const { goals } = state.data;
            return `
                <div class="space-y-8 max-w-3xl">
                    <div class="border-b border-white/10 pb-6">
                        <h1 class="text-3xl font-bold text-white mb-2">System Engine</h1>
                        <p class="text-zinc-400">Convert abstract desires into executable protocols.</p>
                    </div>

                    <div class="bg-zinc-900 p-6 rounded-xl border border-white/10">
                        <label class="block text-sm font-medium text-zinc-500 mb-2 uppercase tracking-wide">New Objective</label>
                        <div class="flex gap-4">
                            <input value="${state.ui.goalInput}" oninput="actions.setGoalInput(this.value)" 
                                placeholder="e.g., Become a full-stack developer..."
                                class="flex-1 bg-zinc-950 border border-zinc-800 rounded px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-colors">
                            <button onclick="actions.createGoal()" class="bg-white text-black font-bold px-6 py-3 rounded hover:bg-zinc-200 transition-colors">Generate</button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${goals.map(g => `
                            <div class="bg-zinc-900/50 border border-white/5 rounded-xl p-6 group">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="text-xl font-bold text-white">${g.title}</h3>
                                    <button onclick="actions.deleteGoal(${g.id})" class="text-zinc-600 hover:text-red-400 transition-colors">${icon('x-circle', 18)}</button>
                                </div>
                                <div class="prose prose-invert prose-sm max-w-none text-zinc-400">
                                    <div class="whitespace-pre-line">${g.systemStr}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${goals.length === 0 ? `
                             <div class="text-center py-12 text-zinc-600">
                                <div class="opacity-20 flex justify-center mb-4">${icon('target', 48)}</div>
                                <p>No systems initialized.</p>
                             </div>
                        ` : ''}
                    </div>
                </div>
            `;
        };

        const LogView = () => {
            const l = state.ui.logInput;
            const canSubmit = l.wins || l.failures;
            
            return `
                <div class="max-w-2xl mx-auto space-y-8">
                     <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-white mb-2">Daily Review</h1>
                        <p class="text-zinc-500">Honesty is the only metric that matters.</p>
                    </div>
                    
                    <div class="bg-zinc-900 border border-white/5 p-8 rounded-xl space-y-8 shadow-2xl">
                        <div>
                            <label class="flex justify-between text-sm font-medium text-zinc-400 mb-4">
                                <span>Focus Level</span><span class="text-white">${l.focus}/10</span>
                            </label>
                            <input type="range" min="1" max="10" value="${l.focus}" oninput="actions.updateLog('focus', this.value)"
                                class="w-full h-2 bg-zinc-800 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                             <div class="flex justify-between text-xs text-zinc-600 mt-2 font-mono">
                                <span>DISTRACTED</span><span>LOCKED IN</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-zinc-400 mb-2">Hours Wasted</label>
                            <div class="flex gap-4">
                                ${[0, 1, 2, 3, 4, "5+"].map(h => `
                                    <button onclick="actions.updateLog('wastedTime', '${h}')"
                                        class="w-10 h-10 rounded border text-sm font-mono transition-all ${l.wastedTime == h ? 'border-red-500 bg-red-500/10 text-white' : 'border-zinc-800 text-zinc-500 hover:border-zinc-600'}">
                                        ${h}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label class="block text-sm font-medium text-zinc-400 mb-2">Wins (Execution)</label>
                                <textarea rows="3" oninput="actions.updateLog('wins', this.value)" placeholder="What did you complete?"
                                    class="w-full bg-zinc-950 border border-zinc-800 rounded p-3 text-sm text-white focus:border-cyan-500 focus:outline-none">${l.wins}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-zinc-400 mb-2">Failures (Excuses)</label>
                                <textarea rows="3" oninput="actions.updateLog('failures', this.value)" placeholder="Why didn't you do more?"
                                    class="w-full bg-zinc-950 border border-zinc-800 rounded p-3 text-sm text-white focus:border-red-500 focus:outline-none">${l.failures}</textarea>
                            </div>
                        </div>

                        <button onclick="actions.submitLog()" ${!canSubmit ? 'disabled' : ''}
                            class="w-full bg-white text-black font-bold py-4 rounded hover:bg-zinc-200 transition-colors disabled:opacity-50">
                            Submit Log & Get Analysis
                        </button>
                    </div>
                </div>
            `;
        };

        const AnalyticsView = () => {
            const { logs, streak, lifeScore } = state.data;
            const { aiResponse, analyzing } = state.ui;
            const displayLogs = logs.length > 0 ? logs : [];

            return `
                 <div class="space-y-8">
                     <div class="border-b border-white/10 pb-6 flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-bold text-white mb-2">Data & Truth</h1>
                            <p class="text-zinc-400">Numbers don't lie. Feelings do.</p>
                        </div>
                        <button onclick="actions.runAnalysis()" ${analyzing ? 'disabled' : ''} class="hidden md:flex items-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 rounded text-sm transition-colors border border-white/5">
                            ${analyzing ? `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>Processing...` 
                                      : `${icon('microscope', 16)} Run Pattern Analysis ✨`}
                        </button>
                    </div>

                    ${aiResponse ? `
                        <div class="bg-zinc-900 border border-purple-500/30 p-6 rounded-xl animate-in slide-in-from-top-4">
                             <h3 class="text-purple-400 font-mono text-xs uppercase tracking-widest mb-3 flex items-center gap-2">${icon('lightbulb', 14)} AI Insight</h3>
                             <p class="text-zinc-300 leading-relaxed whitespace-pre-line">${aiResponse}</p>
                        </div>
                    ` : ''}

                    <button onclick="actions.runAnalysis()" ${analyzing ? 'disabled' : ''} class="md:hidden w-full flex items-center justify-center gap-2 bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-3 rounded text-sm transition-colors border border-white/5">
                         ${analyzing ? "Processing..." : "Run Pattern Analysis ✨"}
                    </button>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-zinc-900 p-6 rounded-xl border border-white/5">
                            <h3 class="text-zinc-500 text-xs uppercase tracking-wider mb-2">Current Streak</h3>
                            <p class="text-4xl font-bold text-white">${streak} <span class="text-sm text-zinc-500 font-normal">days</span></p>
                        </div>
                         <div class="bg-zinc-900 p-6 rounded-xl border border-white/5">
                            <h3 class="text-zinc-500 text-xs uppercase tracking-wider mb-2">Total Logs</h3>
                            <p class="text-4xl font-bold text-white">${logs.length}</p>
                        </div>
                         <div class="bg-zinc-900 p-6 rounded-xl border border-white/5">
                            <h3 class="text-zinc-500 text-xs uppercase tracking-wider mb-2">System Health</h3>
                            <p class="text-4xl font-bold text-cyan-400">${lifeScore}%</p>
                        </div>
                    </div>

                     <div class="bg-zinc-900 p-8 rounded-xl border border-white/5">
                        <h3 class="text-white font-bold mb-6">Focus Consistency</h3>
                        <div class="h-40 flex items-end gap-2">
                            ${displayLogs.slice(-14).map(log => `
                                <div class="flex-1 flex flex-col items-center gap-2 group relative">
                                    <div class="w-full rounded-t transition-all duration-500 ${log.focus >= 7 ? 'bg-cyan-500' : 'bg-zinc-700'}" style="height: ${log.focus * 10}%"></div>
                                    <span class="text-xs text-zinc-600 font-mono hidden md:block">${new Date(log.date).getDate()}</span>
                                    <div class="absolute bottom-full mb-2 bg-black border border-zinc-700 p-2 text-xs text-white rounded opacity-0 group-hover:opacity-100 whitespace-nowrap z-10">Score: ${log.focus}/10</div>
                                </div>
                            `).join('')}
                             ${displayLogs.length === 0 ? `<div class="w-full h-full flex items-center justify-center text-zinc-600 text-sm italic border-2 border-dashed border-zinc-800 rounded">Not enough data to visualize trends.</div>` : ''}
                        </div>
                     </div>
                 </div>
            `;
        };

        const SettingsView = () => {
             const u = state.user;
             return `
                <div class="max-w-2xl space-y-8">
                     <div class="border-b border-white/10 pb-6"><h1 class="text-3xl font-bold text-white mb-2">System Configuration</h1></div>
                     <div class="space-y-6">
                        <div class="bg-zinc-900 p-6 rounded-xl border border-white/5">
                            <h3 class="text-white font-medium mb-4">User Profile</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-zinc-500">Name</label>
                                    <input value="${u.name}" oninput="actions.updateUser('name', this.value)" class="w-full bg-zinc-950 border border-zinc-800 rounded p-2 text-white mt-1">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-500">Feedback Mode</label>
                                    <div class="flex gap-2 mt-1">
                                        ${['Soft', 'Honest', 'Brutal'].map(s => `
                                            <button onclick="actions.updateUser('style', '${s}')" class="px-4 py-2 text-sm rounded border ${u.style === s ? 'border-cyan-500 text-cyan-500' : 'border-zinc-800 text-zinc-500'}">${s}</button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-zinc-900 p-6 rounded-xl border border-red-900/20">
                            <h3 class="text-red-400 font-medium mb-2">Danger Zone</h3>
                             <p class="text-zinc-500 text-sm mb-4">This will wipe all local data including goals, logs, and stats.</p>
                             <button onclick="actions.resetSystem()" class="border border-red-900 text-red-500 px-4 py-2 rounded text-sm hover:bg-red-900/10 transition-colors">Factory Reset System</button>
                        </div>
                         <div class="text-center text-zinc-700 text-xs font-mono pt-8">LifeOS Version 1.0.0 // HTML Edition <br/> Data stored locally. Privacy secured.</div>
                     </div>
                </div>
             `;
        };

        const Modal = () => {
             if (!state.ui.modalOpen) return '';
             const { loading, modalContent } = state.ui;
             
             return `
                <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div class="bg-zinc-900 border border-white/10 w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
                         <div class="p-6 border-b border-white/5 flex justify-between items-center bg-zinc-950">
                            <div class="flex items-center gap-2 text-cyan-400">${icon('brain', 18)} <span class="font-mono text-sm tracking-widest">REALITY ENGINE</span></div>
                            <button onclick="actions.closeModal()" class="hover:text-white text-zinc-500">${icon('x', 20)}</button>
                         </div>
                         <div class="p-8 max-h-[70vh] overflow-y-auto">
                            ${loading ? `
                                <div class="flex flex-col items-center justify-center py-12 space-y-4">
                                   <div class="w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
                                   <p class="text-zinc-500 font-mono text-sm animate-pulse">ANALYZING PATTERNS...</p>
                                </div>
                            ` : `
                                <div class="prose prose-invert prose-p:text-zinc-300 prose-headings:text-white">
                                   <div class="whitespace-pre-wrap font-sans text-lg leading-relaxed">${modalContent}</div>
                                </div>
                            `}
                         </div>
                    </div>
                </div>
             `;
        };

        // --- MAIN RENDER FUNCTION ---

        const render = () => {
            const app = document.getElementById('app');
            
            // Check view logic
            if (state.view === 'onboarding') {
                app.innerHTML = OnboardingView();
                lucide.createIcons();
                return;
            }

            // Main Layout
            app.innerHTML = `
                <div class="flex h-screen overflow-hidden">
                    <div class="md:hidden flex items-center justify-between p-4 border-b border-white/5 bg-zinc-950/80 backdrop-blur-md fixed top-0 w-full z-50">
                        <div class="flex items-center gap-2 text-white">
                             <div class="text-cyan-400">${icon('brain', 24)}</div><span class="font-bold tracking-wider">LIFEOS</span>
                        </div>
                        <button onclick="actions.toggleMobileMenu()" class="text-white">
                            ${state.ui.mobileMenuOpen ? icon('x') : icon('menu')}
                        </button>
                    </div>

                    ${Sidebar()}

                    <main class="flex-1 overflow-y-auto relative scroll-smooth pt-16 md:pt-0">
                         <div class="max-w-5xl mx-auto p-4 md:p-12 pb-32">
                            ${state.view === 'dashboard' ? DashboardView() : ''}
                            ${state.view === 'goals' ? GoalsView() : ''}
                            ${state.view === 'log' ? LogView() : ''}
                            ${state.view === 'analytics' ? AnalyticsView() : ''}
                            ${state.view === 'settings' ? SettingsView() : ''}
                         </div>
                    </main>

                    ${Modal()}
                </div>
            `;
            
            // Re-initialize icons after DOM update
            lucide.createIcons();
        };

        // Initialize
        loadData();

    </script>
</body>
</html>

```